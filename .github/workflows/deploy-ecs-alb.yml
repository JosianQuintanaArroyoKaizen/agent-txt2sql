name: Deploy Streamlit to ECS with ALB

on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'streamlit_app/**'
      - 'cfn/4-ecs-alb-streamlit-template.yaml'
      - '.github/workflows/deploy-ecs-alb.yml'
  workflow_dispatch:

env:
  AWS_REGION: eu-central-1
  ALIAS: txt2sql-dev
  ECR_REPO: txt2sql-streamlit-dev
  STACK_NAME: txt2sql-dev-ecs-alb-streamlit-stack

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Get Bedrock Agent Info
      id: agent
      run: |
        AGENT_ID=$(aws bedrock-agent list-agents \
          --region ${{ env.AWS_REGION }} \
          --query 'agentSummaries[0].agentId' \
          --output text)
        
        AGENT_ALIAS_ID=$(aws bedrock-agent list-agent-aliases \
          --agent-id "$AGENT_ID" \
          --region ${{ env.AWS_REGION }} \
          --query 'agentAliasSummaries[0].agentAliasId' \
          --output text)
        
        echo "agent_id=$AGENT_ID" >> $GITHUB_OUTPUT
        echo "agent_alias_id=$AGENT_ALIAS_ID" >> $GITHUB_OUTPUT

    - name: Get VPC and Subnets
      id: vpc
      run: |
        # Try to find default VPC first
        VPC_ID=$(aws ec2 describe-vpcs \
          --region ${{ env.AWS_REGION }} \
          --filters "Name=isDefault,Values=true" \
          --query 'Vpcs[0].VpcId' \
          --output text 2>/dev/null || echo "")
        
        if [ -z "$VPC_ID" ] || [ "$VPC_ID" = "None" ]; then
          # Use first available VPC
          VPC_ID=$(aws ec2 describe-vpcs \
            --region ${{ env.AWS_REGION }} \
            --query 'Vpcs[0].VpcId' \
            --output text)
        fi
        
        # Get subnets from VPC
        SUBNET_IDS=$(aws ec2 describe-subnets \
          --region ${{ env.AWS_REGION }} \
          --filters "Name=vpc-id,Values=$VPC_ID" \
          --query 'Subnets[*].SubnetId' \
          --output text | tr '\t' ',')
        
        echo "vpc_id=$VPC_ID" >> $GITHUB_OUTPUT
        echo "subnet_ids=$SUBNET_IDS" >> $GITHUB_OUTPUT
        
        echo "Using VPC: $VPC_ID"
        echo "Using Subnets: $SUBNET_IDS"

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd streamlit_app
        docker build -t $ECR_REGISTRY/${{ env.ECR_REPO }}:$IMAGE_TAG .
        docker push $ECR_REGISTRY/${{ env.ECR_REPO }}:$IMAGE_TAG
        docker tag $ECR_REGISTRY/${{ env.ECR_REPO }}:$IMAGE_TAG $ECR_REGISTRY/${{ env.ECR_REPO }}:latest
        docker push $ECR_REGISTRY/${{ env.ECR_REPO }}:latest

    - name: Deploy CloudFormation Stack
      run: |
        aws cloudformation deploy \
          --template-file cfn/4-ecs-alb-streamlit-template.yaml \
          --stack-name ${{ env.STACK_NAME }} \
          --parameter-overrides \
            Alias=${{ env.ALIAS }} \
            ECRRepository=${{ env.ECR_REPO }} \
            AgentId=${{ steps.agent.outputs.agent_id }} \
            AgentAliasId=${{ steps.agent.outputs.agent_alias_id }} \
            VpcId=${{ steps.vpc.outputs.vpc_id }} \
            SubnetIds=${{ steps.vpc.outputs.subnet_ids }} \
          --capabilities CAPABILITY_IAM \
          --region ${{ env.AWS_REGION }}

    - name: Get ALB URL
      id: get-url
      run: |
        ALB_URL=$(aws cloudformation describe-stacks \
          --stack-name ${{ env.STACK_NAME }} \
          --region ${{ env.AWS_REGION }} \
          --query 'Stacks[0].Outputs[?OutputKey==`LoadBalancerURL`].OutputValue' \
          --output text)
        
        ALB_DNS=$(aws cloudformation describe-stacks \
          --stack-name ${{ env.STACK_NAME }} \
          --region ${{ env.AWS_REGION }} \
          --query 'Stacks[0].Outputs[?OutputKey==`LoadBalancerDNS`].OutputValue' \
          --output text)
        
        echo "url=$ALB_URL" >> $GITHUB_OUTPUT
        echo "dns=$ALB_DNS" >> $GITHUB_OUTPUT
        
        echo "::notice title=Streamlit App URL::Your app is available at: $ALB_URL"

    - name: Output Deployment Info
      run: |
        echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Your Streamlit app is available at:**" >> $GITHUB_STEP_SUMMARY
        echo "- URL: ${{ steps.get-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
        echo "- DNS: ${{ steps.get-url.outputs.dns }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "This URL is permanent and will not change." >> $GITHUB_STEP_SUMMARY
        echo "The app is always running and supports WebSocket connections." >> $GITHUB_STEP_SUMMARY

