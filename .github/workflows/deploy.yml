# GitHub Actions CI/CD Pipeline for Bedrock Text2SQL Agent
# This workflow deploys the CloudFormation stacks on push to main branch

name: Deploy Bedrock Text2SQL Agent

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  AWS_REGION: us-west-2
  ALIAS: txt2sql
  ENVIRONMENT: dev

jobs:
  validate:
    name: Validate CloudFormation Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate CloudFormation Templates
        run: |
          echo "Validating CloudFormation templates..."
          aws cloudformation validate-template --template-body file://cfn/1-athena-glue-s3-template.yaml
          aws cloudformation validate-template --template-body file://cfn/2-bedrock-agent-lambda-template.yaml
          aws cloudformation validate-template --template-body file://cfn/3-ec2-streamlit-template.yaml
          echo "✓ All templates are valid"

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: Deploy Stack 1 - Athena, Glue, S3
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          aws cloudformation deploy \
            --template-file cfn/1-athena-glue-s3-template.yaml \
            --stack-name "${STACK_SUFFIX}-athena-glue-s3-stack" \
            --parameter-overrides \
              Alias="${{ env.ALIAS }}-${{ env.ENVIRONMENT }}" \
              AthenaDatabaseName="athena_db" \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Wait for Stack 1
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          aws cloudformation wait stack-create-complete \
            --stack-name "${STACK_SUFFIX}-athena-glue-s3-stack" \
            --region ${{ env.AWS_REGION }} || \
          aws cloudformation wait stack-update-complete \
            --stack-name "${STACK_SUFFIX}-athena-glue-s3-stack" \
            --region ${{ env.AWS_REGION }} || true

      - name: Deploy Stack 2 - Bedrock Agent and Lambda
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          aws cloudformation deploy \
            --template-file cfn/2-bedrock-agent-lambda-template.yaml \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --parameter-overrides \
              Alias="${{ env.ALIAS }}-${{ env.ENVIRONMENT }}" \
              FoundationModel="anthropic.claude-3-haiku-20240307-v1:0" \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Wait for Stack 2
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          aws cloudformation wait stack-create-complete \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --region ${{ env.AWS_REGION }} || \
          aws cloudformation wait stack-update-complete \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --region ${{ env.AWS_REGION }} || true

      - name: Get Agent IDs
        id: agent
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          AGENT_ID=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`BedrockAgentName`].OutputValue' \
            --output text)
          
          AGENT_ALIAS_ID=$(aws bedrock-agent list-agent-aliases \
            --agent-id "${AGENT_ID}" \
            --region ${{ env.AWS_REGION }} \
            --query 'agentAliasSummaries[0].agentAliasId' \
            --output text)
          
          echo "agent_id=$AGENT_ID" >> $GITHUB_OUTPUT
          echo "agent_alias_id=$AGENT_ALIAS_ID" >> $GITHUB_OUTPUT

      - name: Deploy Stack 3 - EC2 Streamlit
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          case "${{ env.AWS_REGION }}" in
            us-west-2) SSH_CIDR="18.237.140.160/29" ;;
            us-east-1) SSH_CIDR="18.206.107.24/29" ;;
            eu-central-1) SSH_CIDR="3.120.181.40/29" ;;
            eu-west-1) SSH_CIDR="18.202.216.48/29" ;;
            eu-west-2) SSH_CIDR="3.8.37.24/29" ;;
            ap-southeast-1) SSH_CIDR="3.0.5.32/29" ;;
            ap-northeast-1) SSH_CIDR="3.112.23.0/29" ;;
            *) SSH_CIDR="18.237.140.160/29" ;;
          esac
          aws cloudformation deploy \
            --template-file cfn/3-ec2-streamlit-template.yaml \
            --stack-name "${STACK_SUFFIX}-ec2-streamlit-stack" \
            --parameter-overrides \
              InstanceType="t3.small" \
              SSHRegionIPsAllowed="${SSH_CIDR}" \
              MapPublicIpOnLaunch="true" \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Get Deployment Summary
        id: summary
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          PUBLIC_DNS=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_SUFFIX}-ec2-streamlit-stack" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`PublicDnsName`].OutputValue' \
            --output text)
          
          echo "public_dns=$PUBLIC_DNS" >> $GITHUB_OUTPUT
          
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Deployment Successful**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Agent ID | ${{ steps.agent.outputs.agent_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agent Alias ID | ${{ steps.agent.outputs.agent_alias_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Streamlit URL | http://${PUBLIC_DNS}:8501 |" >> $GITHUB_STEP_SUMMARY

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to Production
        run: |
          echo "Deploying to production..."
          # Add production deployment steps here
          # Similar to dev deployment but with -prod suffix

      - name: Production Deployment Summary
        run: |
          echo "### Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "✅ All stacks deployed successfully" >> $GITHUB_STEP_SUMMARY

