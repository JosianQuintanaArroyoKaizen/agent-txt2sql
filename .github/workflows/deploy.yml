# GitHub Actions CI/CD Pipeline for Bedrock Text2SQL Agent
# Auto-deploys on push to dev, manual trigger only for production (main)

name: Deploy Bedrock Text2SQL Agent

on:
  push:
    branches:
      - dev  # Auto-deploy dev environment
  workflow_dispatch:  # Manual trigger for production (main branch)
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  AWS_REGION: eu-central-1
  ALIAS: txt2sql
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  validate:
    name: Validate CloudFormation Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate CloudFormation Templates
        run: |
          echo "Validating CloudFormation templates..."
          aws cloudformation validate-template --template-body file://cfn/1-athena-glue-s3-template.yaml
          aws cloudformation validate-template --template-body file://cfn/2-bedrock-agent-lambda-template.yaml
          echo "✓ All templates are valid"

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    environment: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: Check and Clean Stack 1 if Failed
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          STACK_NAME="${STACK_SUFFIX}-athena-glue-s3-stack"
          
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].StackStatus' \
            --output text 2>&1 || echo "DOES_NOT_EXIST")
          
          echo "Stack 1 status: $STACK_STATUS"
          
          if [[ "$STACK_STATUS" =~ (ROLLBACK_COMPLETE|UPDATE_ROLLBACK_COMPLETE|CREATE_FAILED|UPDATE_FAILED) ]]; then
            echo "⚠️ Stack 1 is in failed state. Deleting..."
            aws cloudformation delete-stack \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }}
            aws cloudformation wait stack-delete-complete \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }} || true
            echo "✅ Stack 1 deleted."
          fi

      - name: Deploy Stack 1 - Athena, Glue, S3
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          ALIAS_FULL="${{ env.ALIAS }}-${{ env.ENVIRONMENT }}"
          ALIAS_DB=$(echo "${ALIAS_FULL}" | tr '-' '_')
          aws cloudformation deploy \
            --template-file cfn/1-athena-glue-s3-template.yaml \
            --stack-name "${STACK_SUFFIX}-athena-glue-s3-stack" \
            --parameter-overrides \
              Alias="${{ env.ALIAS }}-${{ env.ENVIRONMENT }}" \
              AliasDb="${ALIAS_DB}" \
              AthenaDatabaseName="athena_db" \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Wait for Stack 1
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          aws cloudformation wait stack-create-complete \
            --stack-name "${STACK_SUFFIX}-athena-glue-s3-stack" \
            --region ${{ env.AWS_REGION }} || \
          aws cloudformation wait stack-update-complete \
            --stack-name "${STACK_SUFFIX}-athena-glue-s3-stack" \
            --region ${{ env.AWS_REGION }} || true

      - name: Check and Clean Stack 2 if Failed
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          STACK_NAME="${STACK_SUFFIX}-bedrock-agent-lambda-stack"
          
          # Check if stack exists and its status
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].StackStatus' \
            --output text 2>&1 || echo "DOES_NOT_EXIST")
          
          echo "Current stack status: $STACK_STATUS"
          
          # If stack is in a failed state, delete it
          if [[ "$STACK_STATUS" =~ (ROLLBACK_COMPLETE|UPDATE_ROLLBACK_COMPLETE|CREATE_FAILED|UPDATE_FAILED) ]]; then
            echo "⚠️ Stack is in failed state ($STACK_STATUS). Deleting..."
            aws cloudformation delete-stack \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }}
            
            echo "Waiting for stack deletion..."
            aws cloudformation wait stack-delete-complete \
              --stack-name "$STACK_NAME" \
              --region ${{ env.AWS_REGION }} || true
            
            echo "✅ Stack deleted. Will create fresh."
          fi

      - name: Deploy Stack 2 - Bedrock Agent and Lambda
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          ALIAS_FULL="${{ env.ALIAS }}-${{ env.ENVIRONMENT }}"
          ALIAS_DB=$(echo "${ALIAS_FULL}" | tr '-' '_')
          aws cloudformation deploy \
            --template-file cfn/2-bedrock-agent-lambda-template.yaml \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --parameter-overrides \
              Alias="${{ env.ALIAS }}-${{ env.ENVIRONMENT }}" \
              FoundationModel="anthropic.claude-3-5-sonnet-20240620-v1:0" \
              AliasDb="${ALIAS_DB}" \
              AthenaDatabaseName="athena_db" \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Wait for Stack 2
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          aws cloudformation wait stack-create-complete \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --region ${{ env.AWS_REGION }} || \
          aws cloudformation wait stack-update-complete \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --region ${{ env.AWS_REGION }} || true

      - name: Get Agent IDs
        id: agent
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          AGENT_ID=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`AgentId`].OutputValue' \
            --output text)
          
          AGENT_ALIAS_ID=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`AgentAliasId`].OutputValue' \
            --output text)
          
          echo "agent_id=$AGENT_ID" >> $GITHUB_OUTPUT
          echo "agent_alias_id=$AGENT_ALIAS_ID" >> $GITHUB_OUTPUT
          echo "Agent ID: $AGENT_ID"
          echo "Agent Alias ID: $AGENT_ALIAS_ID"

      - name: Prepare Agent (Activate CloudFormation Changes)
        run: |
          AGENT_ID="${{ steps.agent.outputs.agent_id }}"
          
          echo "Preparing agent to activate CloudFormation template changes..."
          aws bedrock-agent prepare-agent \
            --agent-id "$AGENT_ID" \
            --region ${{ env.AWS_REGION }} \
            --no-cli-pager
          
          echo "Waiting for agent to be prepared (~30 seconds)..."
          sleep 35
          
          AGENT_STATUS=$(aws bedrock-agent get-agent \
            --agent-id "$AGENT_ID" \
            --region ${{ env.AWS_REGION }} \
            --query 'agent.agentStatus' \
            --output text)
          
          echo "✅ Agent prepared and ready. Status: $AGENT_STATUS"
          echo "Agent instruction is now using the configuration from CloudFormation template"

      - name: Deploy Frontend
        run: |
          cd frontend
          export AGENT_ID="${{ steps.agent.outputs.agent_id }}"
          export AGENT_ALIAS_ID="${{ steps.agent.outputs.agent_alias_id }}"
          export AWS_REGION="${{ env.AWS_REGION }}"
          export ENVIRONMENT="dev"
          ./deploy-simple.sh
          echo "✅ Frontend deployed"

      - name: Get Deployment Summary
        id: summary
        run: |
          STACK_SUFFIX="${{ env.ENVIRONMENT }}-${{ env.AWS_REGION }}"
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          FRONTEND_URL="http://txt2sql-frontend-${ACCOUNT_ID}.s3-website.${{ env.AWS_REGION }}.amazonaws.com"
          API_ID=$(aws apigateway get-rest-apis --region ${{ env.AWS_REGION }} --query "items[?name=='txt2sql-frontend-api'].id" --output text)
          API_URL="https://${API_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com/prod/chat"
          
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Deployment Successful**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agent ID | ${{ steps.agent.outputs.agent_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agent Alias ID | ${{ steps.agent.outputs.agent_alias_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend URL | ${FRONTEND_URL} |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${API_URL} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Queries" >> $GITHUB_STEP_SUMMARY
          echo "- How many records in test_population?" >> $GITHUB_STEP_SUMMARY
          echo "- Show me 5 incidents with code E_A_C_09" >> $GITHUB_STEP_SUMMARY
          echo "- Show me incidents where valuation currency is EUR" >> $GITHUB_STEP_SUMMARY

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: Deploy Stack 1 - Athena, Glue, S3 (Production)
        run: |
          STACK_SUFFIX="prod-${{ env.AWS_REGION }}"
          ALIAS_FULL="${{ env.ALIAS }}-prod"
          ALIAS_DB=$(echo "${ALIAS_FULL}" | tr '-' '_')
          aws cloudformation deploy \
            --template-file cfn/1-athena-glue-s3-template.yaml \
            --stack-name "${STACK_SUFFIX}-athena-glue-s3-stack" \
            --parameter-overrides \
              Alias="${{ env.ALIAS }}-prod" \
              AliasDb="${ALIAS_DB}" \
              AthenaDatabaseName="athena_db" \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Wait for Stack 1 (Production)
        run: |
          STACK_SUFFIX="prod-${{ env.AWS_REGION }}"
          aws cloudformation wait stack-create-complete \
            --stack-name "${STACK_SUFFIX}-athena-glue-s3-stack" \
            --region ${{ env.AWS_REGION }} || \
          aws cloudformation wait stack-update-complete \
            --stack-name "${STACK_SUFFIX}-athena-glue-s3-stack" \
            --region ${{ env.AWS_REGION }} || true

      - name: Deploy Stack 2 - Bedrock Agent and Lambda (Production)
        run: |
          STACK_SUFFIX="prod-${{ env.AWS_REGION }}"
          ALIAS_FULL="${{ env.ALIAS }}-prod"
          ALIAS_DB=$(echo "${ALIAS_FULL}" | tr '-' '_')
          aws cloudformation deploy \
            --template-file cfn/2-bedrock-agent-lambda-template.yaml \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --parameter-overrides \
              Alias="${{ env.ALIAS }}-prod" \
              FoundationModel="anthropic.claude-3-5-sonnet-20240620-v1:0" \
              AliasDb="${ALIAS_DB}" \
              AthenaDatabaseName="athena_db" \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Wait for Stack 2 (Production)
        run: |
          STACK_SUFFIX="prod-${{ env.AWS_REGION }}"
          aws cloudformation wait stack-create-complete \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --region ${{ env.AWS_REGION }} || \
          aws cloudformation wait stack-update-complete \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --region ${{ env.AWS_REGION }} || true

      - name: Get Agent IDs (Production)
        id: agent
        run: |
          STACK_SUFFIX="prod-${{ env.AWS_REGION }}"
          AGENT_ID=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`AgentId`].OutputValue' \
            --output text)
          
          AGENT_ALIAS_ID=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_SUFFIX}-bedrock-agent-lambda-stack" \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`AgentAliasId`].OutputValue' \
            --output text)
          
          echo "agent_id=$AGENT_ID" >> $GITHUB_OUTPUT
          echo "agent_alias_id=$AGENT_ALIAS_ID" >> $GITHUB_OUTPUT
          echo "Agent ID: $AGENT_ID"
          echo "Agent Alias ID: $AGENT_ALIAS_ID"

      - name: Prepare Agent (Production)
        run: |
          AGENT_ID="${{ steps.agent.outputs.agent_id }}"
          
          echo "Preparing production agent..."
          aws bedrock-agent prepare-agent \
            --agent-id "$AGENT_ID" \
            --region ${{ env.AWS_REGION }} \
            --no-cli-pager
          
          echo "Waiting for agent to be prepared (~30 seconds)..."
          sleep 35
          
          AGENT_STATUS=$(aws bedrock-agent get-agent \
            --agent-id "$AGENT_ID" \
            --region ${{ env.AWS_REGION }} \
            --query 'agent.agentStatus' \
            --output text)
          
          echo "✅ Production agent ready. Status: $AGENT_STATUS"

      - name: Deploy Frontend (Production)
        run: |
          cd frontend
          export AGENT_ID="${{ steps.agent.outputs.agent_id }}"
          export AGENT_ALIAS_ID="${{ steps.agent.outputs.agent_alias_id }}"
          export AWS_REGION="${{ env.AWS_REGION }}"
          export ENVIRONMENT="prod"
          ./deploy-simple.sh
          echo "✅ Production frontend deployed"

      - name: Production Deployment Summary
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          FRONTEND_URL="http://txt2sql-frontend-prod-${ACCOUNT_ID}.s3-website.${{ env.AWS_REGION }}.amazonaws.com"
          API_ID=$(aws apigateway get-rest-apis --region ${{ env.AWS_REGION }} --query "items[?name=='txt2sql-frontend-api'].id" --output text)
          API_URL="https://${API_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com/prod/chat"
          
          echo "### Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Production Deployment Successful**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | production |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agent ID | ${{ steps.agent.outputs.agent_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agent Alias ID | ${{ steps.agent.outputs.agent_alias_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend URL | ${FRONTEND_URL} |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${API_URL} |" >> $GITHUB_STEP_SUMMARY

