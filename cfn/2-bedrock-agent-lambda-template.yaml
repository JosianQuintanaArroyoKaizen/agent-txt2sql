AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation template to create an AWS Bedrock Agent resource and Lambda function

Parameters:
  FoundationModel:
    Type: String
    Default: 'eu.anthropic.claude-3-haiku-20240307-v1:0'
    Description: 'Foundation model ID. Use eu. prefix for GDPR compliance in EU regions'
  Alias:
    Type: String
    Default: '{ENTER ALIAS}'
  AthenaDatabaseName:
    Type: String
    Default: 'athena_db'
    Description: 'Base name of the Athena database (will be prefixed with the Alias)'
  AliasDb:
    Type: String
    Default: '{ENTER ALIAS DB}'
    Description: 'Sanitized alias (underscores only) used for Athena database names.'

Resources:
  AthenaQueryLambdaExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonAthenaFullAccess
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - !Ref CloudWatchLogsPolicy

  CloudWatchLogsPolicy:
    Type: 'AWS::IAM::ManagedPolicy'
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*:*"

  BedrockAgentExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonBedrockFullAccess
        - !Ref LambdaInvokePolicy

  LambdaInvokePolicy:
    Type: 'AWS::IAM::ManagedPolicy'
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - 'lambda:InvokeFunction'
            Resource: !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:AthenaQueryLambda-${Alias}-${AWS::Region}-${AWS::AccountId}'

  AthenaQueryLambda:
    Type: 'AWS::Lambda::Function'
    Properties:
      FunctionName: !Sub 'AthenaQueryLambda-${Alias}-${AWS::Region}-${AWS::AccountId}'
      Handler: index.lambda_handler
      Role: !GetAtt AthenaQueryLambdaExecutionRole.Arn
      Runtime: python3.12
      MemorySize: 1024
      Timeout: 120
      #ReservedConcurrentExecutions: 2  # Set to your desired number
      Environment:
        Variables:
          S3Output: !Sub "s3://sl-athena-output-${Alias}-${AWS::AccountId}-${AWS::Region}/"
      Code:
        ZipFile: |
          import boto3
          from time import sleep
          import os
          import logging

          # Initialize the Athena client
          athena_client = boto3.client('athena')
          logger = logging.getLogger()
          logger.setLevel(logging.INFO)

          def lambda_handler(event, context):
              logger.info(f"Received event: {event}")

              def athena_query_handler(event):
                  try:
                      # Extracting the SQL query
                      query = event['requestBody']['content']['application/json']['properties'][0]['value']
                      logger.info(f"Executing query: {query}")

                      s3_output = os.environ.get('S3Output')
                      if not s3_output:
                          raise Exception("S3Output environment variable is not set")

                      # Execute the query and wait for completion
                      execution_id = execute_athena_query(query, s3_output)
                      result = get_query_results(execution_id)

                      return result

                  except Exception as e:
                      logger.error(f"Error in athena_query_handler: {str(e)}")
                      raise

              def execute_athena_query(query, s3_output):
                  try:
                      response = athena_client.start_query_execution(
                          QueryString=query,
                          ResultConfiguration={'OutputLocation': s3_output}
                      )
                      return response['QueryExecutionId']
                  except Exception as e:
                      logger.error(f"Failed to start query execution: {str(e)}")
                      raise

              def check_query_status(execution_id):
                  try:
                      response = athena_client.get_query_execution(QueryExecutionId=execution_id)
                      return response['QueryExecution']['Status']['State']
                  except Exception as e:
                      logger.error(f"Failed to check query status: {str(e)}")
                      raise

              def get_query_results(execution_id):
                  try:
                      while True:
                          status = check_query_status(execution_id)
                          if status in ['SUCCEEDED', 'FAILED', 'CANCELLED']:
                              break
                          sleep(1)  # Polling interval

                      if status == 'SUCCEEDED':
                          return athena_client.get_query_results(QueryExecutionId=execution_id)
                      else:
                          logger.error(f"Query failed with status '{status}'")
                          raise Exception(f"Query failed with status '{status}'")
                  except Exception as e:
                      logger.error(f"Failed to get query results: {str(e)}")
                      raise

              try:
                  action_group = event.get('actionGroup')
                  api_path = event.get('apiPath')

                  logger.info(f"api_path: {api_path}")

                  result = ''
                  response_code = 200

                  if api_path == '/athenaQuery':
                      result = athena_query_handler(event)
                  else:
                      response_code = 404
                      result = {"error": f"Unrecognized api path: {action_group}::{api_path}"}

                  response_body = {
                      'application/json': {
                          'body': result
                      }
                  }

                  action_response = {
                      'actionGroup': action_group,
                      'apiPath': api_path,
                      'httpMethod': event.get('httpMethod'),
                      'httpStatusCode': response_code,
                      'responseBody': response_body
                  }

                  api_response = {'messageVersion': '1.0', 'response': action_response}
                  return api_response

              except Exception as e:
                  logger.error(f"Unhandled exception: {str(e)}")
                  raise

  LambdaInvokePermission:
    Type: 'AWS::Lambda::Permission'
    DependsOn: AthenaQueryLambda
    Properties:
      FunctionName: !GetAtt AthenaQueryLambda.Arn
      Action: 'lambda:InvokeFunction'
      Principal: 'bedrock.amazonaws.com'
      SourceArn: !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:agent/*'

  BedrockAgent:
    Type: "AWS::Bedrock::Agent"
    DependsOn: LambdaInvokePermission
    Properties:
      AgentName: !Sub 'AthenaAgent-${Alias}-${AWS::Region}-${AWS::AccountId}'
      AgentResourceRoleArn: !GetAtt BedrockAgentExecutionRole.Arn
      AutoPrepare: 'True'
      FoundationModel: !Ref FoundationModel
      Instruction: |
        You are a SQL analyst that creates and executes queries for Amazon Athena.
        When a user asks about data, generate the SQL query and execute it using the athenaQuery function.
        Return both the query and the results.

  BedrockAgentAlias:
    Type: 'AWS::Bedrock::AgentAlias'
    DependsOn: BedrockAgent
    Properties:
      AgentAliasName: !Sub '${Alias}-${AWS::Region}-alias'
      AgentId: !GetAtt BedrockAgent.AgentId

Outputs:
  BedrockAgentName:
    Description: 'Name of the Bedrock Agent created'
    Value: !Ref BedrockAgent
  AthenaQueryLambdaArn:
    Description: 'ARN of the Athena Query Lambda function'
    Value: !GetAtt AthenaQueryLambda.Arn